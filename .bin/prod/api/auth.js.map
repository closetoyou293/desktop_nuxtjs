{"version":3,"sources":["../../../server/api/auth.js"],"names":["module","exports","api","get","req","res","session","_id","json","err","status","Server","Msg","user","off","DB","Users","findOne","select","populate","path","then","UserData","database","null","data","e","false","post","username","password","body","on","auth","email","$or","NewSetting","Setting","NewUser","profile","name","setting","id","of","save","User","destroy"],"mappings":"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","file":"auth.js","sourcesContent":["module.exports = (api) => {\r\n    api.get('/', (req, res) => {\r\n        if(!req.session._id) return res.json({err: true, status: Server.Msg.user.off });\r\n        \r\n        Server.DB.Users\r\n        .findOne({'_id': req.session._id})\r\n        .select('profile')\r\n        .populate({ path: 'setting', select: 'theme' })\r\n        .then(\r\n            (UserData) => {\r\n                if(!UserData) return res.json({err: true, status: Server.Msg.database.get.null});\r\n\r\n                res.json({err: false, data: UserData});\r\n            },\r\n            (e) => res.json({err: true, status: Server.Msg.database.get.false})\r\n        );\r\n    });\r\n\r\n    api.post('/login', (req, res) => {\r\n        const { username, password } = req.body\r\n        if(req.session._id) return res.json({err: true, status: Server.Msg.user.on });\r\n        if(username == '' || password == '') return res.json({err: true, status: 'Dữ liệu đầu vào không đủ'});\r\n\r\n        Server.DB.Users\r\n        .findOne({'auth.username': username})\r\n        .select('auth ')\r\n        .then(\r\n            (UserData) => {\r\n                //Login False\r\n                if(!UserData) return res.json({err: true, status: 'Tài khoản này không tồn tại'});\r\n                if(UserData.auth.password != password) return res.json({err: true, status: 'Mật khẩu không chính xác'});\r\n\r\n                //Login Done\r\n                req.session._id = UserData._id\r\n                res.json({err: false});\r\n            },\r\n            (e) => res.json({err: true, status: Server.Msg.database.get.false})\r\n        );\r\n    });\r\n\r\n    api.post('/signup', (req, res) => {\r\n        const { username, password, email } = req.body\r\n        if(req.session._id) return res.json({err: true, status: Server.Msg.user.on });\r\n        if(username == '' || password == '' || email == '') return res.json({err: true, status: 'Dữ liệu đầu vào không đủ'});\r\n\r\n        Server.DB.Users\r\n        .findOne({$or : [ {'auth.username': username}, {'profile.email': email} ]})\r\n        .select('auth')\r\n        .then(\r\n            (UserData) => {\r\n                //Reg False\r\n                if(UserData) return res.json({err: true, status: 'Tài khoản hoặc email đã tồn tại'});\r\n\r\n                //Reg True\r\n                let NewSetting = new Server.DB.Setting();\r\n                let NewUser = new Server.DB.Users({\r\n                    auth: {\r\n                        username: username,\r\n                        password: password\r\n                    },\r\n                    profile: {\r\n                        name: username,\r\n                        email: email,             \r\n                    },\r\n                    setting: NewSetting._id\r\n                });\r\n                NewUser.profile.id = NewUser._id;\r\n                NewSetting.of = NewUser._id;\r\n                //Save\r\n                NewSetting.save(err => {if(err) return res.json({err: true, status: Server.Msg.database.save.false})});\r\n                NewUser.save((err, User) => {\r\n                    if(err) return res.json({err: true, status: Server.Msg.database.save.false});\r\n                    req.session._id = User._id;\r\n                    res.json({err: false});\r\n                });\r\n            },\r\n            (e) => res.json({err: true, status: Server.Msg.database.get.false})\r\n        );\r\n    });\r\n\r\n    api.get('/logout', (req, res) => {\r\n        if(!req.session._id) return res.json({err: true, status: Server.Msg.user.off });\r\n        req.session.destroy(err => {\r\n            if(err) return res.json({err: true, status: 'Chưa thể đăng xuất ở thời điểm hiện tại'});\r\n\r\n            req.session = null;\r\n            res.json({err: false, status: 'Đăng xuất thành công'});\r\n        });\r\n    });\r\n}"]}